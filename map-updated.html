<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‰¿í”Œë ˆì´ìŠ¤ - ì„œìš¸ì‹œ ì‹¤ì‹œê°„ ì¸êµ¬ í˜„í™©</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 2em;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 120px);
        }
        
        #map {
            flex: 1;
            height: 100%;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        
        .stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stats h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .legend {
            margin-top: 20px;
        }
        
        .legend h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¤« ì‰¿í”Œë ˆì´ìŠ¤</h1>
        <p>ì„œìš¸ì‹œ ì‹¤ì‹œê°„ ì¸êµ¬ ë°€ë„ ë° í˜¼ì¡ë„ í˜„í™©</p>
    </div>
    
    <div class="container">
        <div id="map"></div>
        <div class="sidebar">
            <div class="stats">
                <h3>ğŸ“Š ì‹¤ì‹œê°„ í†µê³„</h3>
                <div class="stat-item">
                    <span>ì´ ì§€ì—­ ìˆ˜:</span>
                    <span id="total-count">ë¡œë”©ì¤‘...</span>
                </div>
                <div class="stat-item">
                    <span>ê¸°ë³¸ ì§€ì—­:</span>
                    <span id="places-count">-</span>
                </div>
                <div class="stat-item">
                    <span>ì‹¤ì‹œê°„ ì •ë¥˜ì¥:</span>
                    <span id="crowd-count">-</span>
                </div>
                <div class="stat-item">
                    <span>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:</span>
                    <span id="last-update">-</span>
                </div>
            </div>
            
            <div class="legend">
                <h4>ğŸ¨ í˜¼ì¡ë„ ë²”ë¡€</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4CAF50;"></div>
                    <span>ë³´í†µ (ë ˆë²¨ 1)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF9800;"></div>
                    <span>í˜¼ì¡ (ë ˆë²¨ 2)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #F44336;"></div>
                    <span>ë§¤ìš° í˜¼ì¡ (ë ˆë²¨ 3+)</span>
                </div>
            </div>
            
            <div class="legend">
                <h4>ğŸ“ ë°ì´í„° ì†ŒìŠ¤</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2196F3;"></div>
                    <span>ì„œìš¸ì‹œ ê¸°ë³¸ ë°ì´í„°</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9C27B0;"></div>
                    <span>C-ITS ì‹¤ì‹œê°„ ë°ì´í„°</span>
                </div>
            </div>
            
            <div id="loading" class="loading">
                ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
            
            <div id="error" class="error" style="display: none;">
                ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ì§€ë„ ì´ˆê¸°í™” (ì„œìš¸ ì¤‘ì‹¬)
        const map = L.map('map').setView([37.5665, 126.9780], 11);
        
        // íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        // í˜¼ì¡ë„ë³„ ìƒ‰ìƒ í•¨ìˆ˜
        function getCrowdColor(crowdLevel, dataType) {
            if (dataType === 'realtime_crowd') {
                // C-ITS ì‹¤ì‹œê°„ ë°ì´í„°
                switch(crowdLevel) {
                    case 1: return '#9C27B0'; // ë³´í†µ - ë³´ë¼ìƒ‰
                    case 2: return '#E91E63'; // í˜¼ì¡ - í•‘í¬ìƒ‰
                    default: return '#F44336'; // ë§¤ìš° í˜¼ì¡ - ë¹¨ê°„ìƒ‰
                }
            } else {
                // ê¸°ë³¸ ì§€ì—­ ë°ì´í„°
                switch(crowdLevel) {
                    case 1: return '#4CAF50'; // ë³´í†µ - ì´ˆë¡ìƒ‰
                    case 2: return '#FF9800'; // í˜¼ì¡ - ì£¼í™©ìƒ‰
                    default: return '#F44336'; // ë§¤ìš° í˜¼ì¡ - ë¹¨ê°„ìƒ‰
                }
            }
        }
        
        // ë§ˆì»¤ ìƒì„± í•¨ìˆ˜
        function createMarker(location) {
            const color = getCrowdColor(location.crowdLevel, location.type);
            const isRealtime = location.type === 'realtime_crowd';
            
            const marker = L.circleMarker([location.lat, location.lng], {
                radius: isRealtime ? 6 : 8,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });
            
            const popupContent = `
                <div style="min-width: 200px;">
                    <h4 style="margin: 0 0 10px 0; color: #333;">${location.name}</h4>
                    <p><strong>í˜¼ì¡ë„:</strong> ${location.crowdLevel} (${location.walkingRecommendation})</p>
                    <p><strong>ì¸êµ¬:</strong> ${location.population?.toLocaleString() || 'N/A'}ëª…</p>
                    <p><strong>ì†ŒìŒ ìˆ˜ì¤€:</strong> ${location.noiseLevel}</p>
                    <p><strong>ì¹´í…Œê³ ë¦¬:</strong> ${location.category}</p>
                    <p><strong>ë°ì´í„° ì†ŒìŠ¤:</strong> ${location.dataSource}</p>
                    <p><strong>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:</strong> ${new Date(location.lastUpdated).toLocaleString('ko-KR')}</p>
                    ${location.district ? `<p><strong>ì§€ì—­:</strong> ${location.district}</p>` : ''}
                </div>
            `;
            
            marker.bindPopup(popupContent);
            return marker;
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStats(data, metadata) {
            document.getElementById('total-count').textContent = metadata.total;
            document.getElementById('places-count').textContent = metadata.dataSources?.places || 0;
            document.getElementById('crowd-count').textContent = metadata.dataSources?.uniqueCrowdStations || 0;
            document.getElementById('last-update').textContent = new Date(metadata.timestamp).toLocaleString('ko-KR');
        }
        
        // ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                
                const response = await fetch('https://48hywqoyra.execute-api.us-east-1.amazonaws.com/prod/population');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                }
                
                // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                map.eachLayer(layer => {
                    if (layer instanceof L.CircleMarker) {
                        map.removeLayer(layer);
                    }
                });
                
                // ìƒˆ ë§ˆì»¤ ì¶”ê°€
                result.data.forEach(location => {
                    if (location.lat && location.lng) {
                        const marker = createMarker(location);
                        marker.addTo(map);
                    }
                });
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                updateStats(result.data, result.metadata);
                
                document.getElementById('loading').style.display = 'none';
                console.log('ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', result.metadata);
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `ì˜¤ë¥˜: ${error.message}`;
            }
        }
        
        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        loadData();
        
        // 5ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
        setInterval(loadData, 5 * 60 * 1000);
        
        console.log('ì‰¿í”Œë ˆì´ìŠ¤ ì§€ë„ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    </script>
</body>
</html>
