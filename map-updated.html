<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>쉿플레이스 - 서울시 실시간 인구 현황</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 2em;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 120px);
        }
        
        #map {
            flex: 1;
            height: 100%;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        
        .stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stats h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .legend {
            margin-top: 20px;
        }
        
        .legend h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🤫 쉿플레이스</h1>
        <p>서울시 실시간 인구 밀도 및 혼잡도 현황</p>
    </div>
    
    <div class="container">
        <div id="map"></div>
        <div class="sidebar">
            <div class="stats">
                <h3>📊 실시간 통계</h3>
                <div class="stat-item">
                    <span>총 지역 수:</span>
                    <span id="total-count">로딩중...</span>
                </div>
                <div class="stat-item">
                    <span>기본 지역:</span>
                    <span id="places-count">-</span>
                </div>
                <div class="stat-item">
                    <span>실시간 정류장:</span>
                    <span id="crowd-count">-</span>
                </div>
                <div class="stat-item">
                    <span>마지막 업데이트:</span>
                    <span id="last-update">-</span>
                </div>
            </div>
            
            <div class="legend">
                <h4>🎨 혼잡도 범례</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4CAF50;"></div>
                    <span>보통 (레벨 1)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF9800;"></div>
                    <span>혼잡 (레벨 2)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #F44336;"></div>
                    <span>매우 혼잡 (레벨 3+)</span>
                </div>
            </div>
            
            <div class="legend">
                <h4>📍 데이터 소스</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2196F3;"></div>
                    <span>서울시 기본 데이터</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9C27B0;"></div>
                    <span>C-ITS 실시간 데이터</span>
                </div>
            </div>
            
            <div id="loading" class="loading">
                데이터를 불러오는 중...
            </div>
            
            <div id="error" class="error" style="display: none;">
                데이터를 불러오는데 실패했습니다.
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 지도 초기화 (서울 중심)
        const map = L.map('map').setView([37.5665, 126.9780], 11);
        
        // 타일 레이어 추가
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // 혼잡도별 색상 함수
        function getCrowdColor(crowdLevel, dataType) {
            if (dataType === 'realtime_crowd') {
                // C-ITS 실시간 데이터
                switch(crowdLevel) {
                    case 1: return '#9C27B0'; // 보통 - 보라색
                    case 2: return '#E91E63'; // 혼잡 - 핑크색
                    default: return '#F44336'; // 매우 혼잡 - 빨간색
                }
            } else {
                // 기본 지역 데이터
                switch(crowdLevel) {
                    case 1: return '#4CAF50'; // 보통 - 초록색
                    case 2: return '#FF9800'; // 혼잡 - 주황색
                    default: return '#F44336'; // 매우 혼잡 - 빨간색
                }
            }
        }
        
        // 마커 생성 함수
        function createMarker(location) {
            const color = getCrowdColor(location.crowdLevel, location.type);
            const isRealtime = location.type === 'realtime_crowd';
            
            const marker = L.circleMarker([location.lat, location.lng], {
                radius: isRealtime ? 6 : 8,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });
            
            const popupContent = `
                <div style="min-width: 200px;">
                    <h4 style="margin: 0 0 10px 0; color: #333;">${location.name}</h4>
                    <p><strong>혼잡도:</strong> ${location.crowdLevel} (${location.walkingRecommendation})</p>
                    <p><strong>인구:</strong> ${location.population?.toLocaleString() || 'N/A'}명</p>
                    <p><strong>소음 수준:</strong> ${location.noiseLevel}</p>
                    <p><strong>카테고리:</strong> ${location.category}</p>
                    <p><strong>데이터 소스:</strong> ${location.dataSource}</p>
                    <p><strong>마지막 업데이트:</strong> ${new Date(location.lastUpdated).toLocaleString('ko-KR')}</p>
                    ${location.district ? `<p><strong>지역:</strong> ${location.district}</p>` : ''}
                </div>
            `;
            
            marker.bindPopup(popupContent);
            return marker;
        }
        
        // 통계 업데이트 함수
        function updateStats(data, metadata) {
            document.getElementById('total-count').textContent = metadata.total;
            document.getElementById('places-count').textContent = metadata.dataSources?.places || 0;
            document.getElementById('crowd-count').textContent = metadata.dataSources?.uniqueCrowdStations || 0;
            document.getElementById('last-update').textContent = new Date(metadata.timestamp).toLocaleString('ko-KR');
        }
        
        // 데이터 로드 함수
        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                
                const response = await fetch('https://48hywqoyra.execute-api.us-east-1.amazonaws.com/prod/population');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || '데이터 로드 실패');
                }
                
                // 기존 마커 제거
                map.eachLayer(layer => {
                    if (layer instanceof L.CircleMarker) {
                        map.removeLayer(layer);
                    }
                });
                
                // 새 마커 추가
                result.data.forEach(location => {
                    if (location.lat && location.lng) {
                        const marker = createMarker(location);
                        marker.addTo(map);
                    }
                });
                
                // 통계 업데이트
                updateStats(result.data, result.metadata);
                
                document.getElementById('loading').style.display = 'none';
                console.log('데이터 로드 완료:', result.metadata);
                
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `오류: ${error.message}`;
            }
        }
        
        // 초기 데이터 로드
        loadData();
        
        // 5분마다 자동 새로고침
        setInterval(loadData, 5 * 60 * 1000);
        
        console.log('쉿플레이스 지도가 초기화되었습니다.');
    </script>
</body>
</html>
